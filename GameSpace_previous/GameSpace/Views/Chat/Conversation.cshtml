@model GameSpace.Models.DM_Conversations
@{
    ViewData["Title"] = "èŠå¤©å°è©± - GameSpace";
    Layout = "_Layout";
    var otherUser = Model.Party1Id == 1 ? Model.Party2 : Model.Party1;
}

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>èˆ‡ @otherUser.Username çš„å°è©± - GameSpace</title>
    <style>
        :root{
            --bg:#eef3f8; --bg2:#ffffff; --ink:#1f2937; --muted:#64748b; --line:#e5e7eb;
            --surface:rgba(255,255,255,.75); --glass:rgba(255,255,255,.45);
            --accent:#7557ff; --accent-2:#34d2ff; --accent-3:#22c55e; --accent-4:#ef4444;
            --radius:18px; --radius-sm:12px; --shadow:0 18px 40px rgba(17,24,39,.12);
            --blur:14px;
        }
        body.dark{
            --bg:#0c111b; --bg2:#0a0f18; --ink:#e5edff; --muted:#9fb1c9; --line:#1e2b43;
            --surface:rgba(22,30,48,.65); --glass:rgba(18,24,39,.50);
            --shadow:0 18px 42px rgba(0,0,0,.35);
        }
        *{box-sizing:border-box} html,body{height:100%}
        body{
            margin:0; color:var(--ink); font:16px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
            background:
                radial-gradient(900px 500px at -10% -10%, rgba(117,87,255,.10), transparent 60%),
                radial-gradient(800px 460px at 110% 10%, rgba(52,210,255,.10), transparent 50%),
                linear-gradient(180deg, var(--bg), var(--bg2));
        }
        .wrap{max-width:1200px; margin:0 auto; padding:0 16px; height:100vh; display:flex; flex-direction:column;}
        
        /* èŠå¤©é ­éƒ¨ */
        .chat-header{
            background:var(--glass); border:1px solid var(--line); border-radius:20px 20px 0 0;
            padding:20px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
            display:flex; align-items:center; gap:15px;
        }
        .chat-avatar{
            width:50px; height:50px; border-radius:50%; background:var(--accent);
            display:flex; align-items:center; justify-content:center; color:#fff;
            font-size:20px; font-weight:700;
        }
        .chat-user-info{
            flex:1;
        }
        .chat-user-name{
            font-size:18px; font-weight:700; color:var(--ink); margin-bottom:5px;
        }
        .chat-user-status{
            font-size:14px; color:var(--muted);
        }
        .chat-actions{
            display:flex; gap:10px;
        }
        .btn{
            padding:8px 16px; border:none; border-radius:8px; font-weight:600;
            cursor:pointer; transition:all 0.3s ease; text-decoration:none; display:inline-block;
        }
        .btn-secondary{
            background:var(--surface); color:var(--ink); border:1px solid var(--line);
        }
        .btn-secondary:hover{background:var(--line)}
        
        /* æ¶ˆæ¯å€åŸŸ */
        .chat-messages{
            flex:1; background:var(--bg2); border-left:1px solid var(--line); border-right:1px solid var(--line);
            padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:15px;
        }
        .message{
            display:flex; gap:10px; max-width:70%;
        }
        .message.sent{
            align-self:flex-end; flex-direction:row-reverse;
        }
        .message.received{
            align-self:flex-start;
        }
        .message-avatar{
            width:40px; height:40px; border-radius:50%; background:var(--accent);
            display:flex; align-items:center; justify-content:center; color:#fff;
            font-size:14px; font-weight:700; flex-shrink:0;
        }
        .message-content{
            background:var(--surface); border:1px solid var(--line); border-radius:15px;
            padding:12px 16px; position:relative;
        }
        .message.sent .message-content{
            background:var(--accent); color:#fff; border-color:var(--accent);
        }
        .message-text{
            margin:0; line-height:1.4;
        }
        .message-meta{
            display:flex; justify-content:space-between; align-items:center; margin-top:5px;
            font-size:12px; color:var(--muted);
        }
        .message.sent .message-meta{
            color:rgba(255,255,255,.7);
        }
        .message-time{
            margin:0;
        }
        .message-status{
            margin:0; margin-left:10px;
        }
        
        /* è¼¸å…¥å€åŸŸ */
        .chat-input{
            background:var(--glass); border:1px solid var(--line); border-radius:0 0 20px 20px;
            padding:20px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
        }
        .input-container{
            display:flex; gap:10px; align-items:flex-end;
        }
        .message-input{
            flex:1; padding:12px 16px; border:1px solid var(--line); border-radius:12px;
            background:var(--bg2); color:var(--ink); font-size:16px; resize:none;
            min-height:50px; max-height:120px;
        }
        .message-input:focus{
            outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(117,87,255,.1);
        }
        .send-btn{
            padding:12px 24px; border:none; border-radius:12px; font-weight:700;
            background:var(--accent); color:#fff; cursor:pointer; transition:all 0.3s ease;
        }
        .send-btn:hover{
            background:#6d28d9; transform:translateY(-1px);
        }
        .send-btn:disabled{
            opacity:0.5; cursor:not-allowed; transform:none;
        }
        
        /* ç©ºç‹€æ…‹ */
        .empty-messages{
            text-align:center; padding:60px 20px; color:var(--muted);
        }
        .empty-icon{font-size:48px; margin-bottom:20px}
        .empty-title{font-size:18px; font-weight:700; margin-bottom:10px; color:var(--ink)}
        .empty-desc{font-size:14px}
    </style>
</head>
<body>
    <div class="wrap">
        <!-- èŠå¤©é ­éƒ¨ -->
        <div class="chat-header">
            <div class="chat-avatar">
                @otherUser.Username.Substring(0, 1).ToUpper()
            </div>
            <div class="chat-user-info">
                <div class="chat-user-name">@otherUser.Username</div>
                <div class="chat-user-status">åœ¨ç·š</div>
            </div>
            <div class="chat-actions">
                <button class="btn btn-secondary" onclick="goBack()">è¿”å›</button>
                <button class="btn btn-secondary" onclick="clearChat()">æ¸…ç©º</button>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯å€åŸŸ -->
        <div class="chat-messages" id="chatMessages">
            @if (Model.DM_Messages.Any())
            {
                @foreach (var message in Model.DM_Messages)
                {
                    var isSent = message.SenderUserId == 1;
                    var messageClass = isSent ? "sent" : "received";
                    var senderName = isSent ? "æˆ‘" : message.SenderUser.Username;
                    
                    <div class="message @messageClass">
                        <div class="message-avatar">
                            @senderName.Substring(0, 1).ToUpper()
                        </div>
                        <div class="message-content">
                            <p class="message-text">@message.MessageContent</p>
                            <div class="message-meta">
                                <span class="message-time">@message.SentAt.ToString("HH:mm")</span>
                                @if (isSent)
                                {
                                    <span class="message-status">
                                        @if (message.ReadAt.HasValue)
                                        {
                                            <span>å·²è®€</span>
                                        }
                                        else
                                        {
                                            <span>å·²ç™¼é€</span>
                                        }
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-messages">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div class="empty-title">é–‹å§‹å°è©±</div>
                    <div class="empty-desc">ç™¼é€ç¬¬ä¸€æ¢æ¶ˆæ¯é–‹å§‹èŠå¤©å§ï¼</div>
                </div>
            }
        </div>
        
        <!-- è¼¸å…¥å€åŸŸ -->
        <div class="chat-input">
            <div class="input-container">
                <textarea class="message-input" id="messageInput" placeholder="è¼¸å…¥æ¶ˆæ¯..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script>
        const conversationId = @Model.ConversationId;
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) {
                return;
            }
            
            // ç¦ç”¨ç™¼é€æŒ‰éˆ•
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'ç™¼é€ä¸­...';
            
            fetch('/Chat/SendMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    conversationId: conversationId,
                    content: content,
                    messageType: 'Text'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    input.value = '';
                    input.style.height = 'auto';
                    
                    // é‡æ–°è¼‰å…¥æ¶ˆæ¯
                    loadMessages();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            })
            .finally(() => {
                // æ¢å¾©ç™¼é€æŒ‰éˆ•
                sendBtn.disabled = false;
                sendBtn.textContent = 'ç™¼é€';
            });
        }
        
        function loadMessages() {
            fetch(`/Chat/GetMessages?conversationId=${conversationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateMessages(data.messages);
                }
            })
            .catch(error => {
                console.error('è¼‰å…¥æ¶ˆæ¯å¤±æ•—:', error);
            });
        }
        
        function updateMessages(messages) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-messages">
                        <div class="empty-icon">ğŸ’¬</div>
                        <div class="empty-title">é–‹å§‹å°è©±</div>
                        <div class="empty-desc">ç™¼é€ç¬¬ä¸€æ¢æ¶ˆæ¯é–‹å§‹èŠå¤©å§ï¼</div>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const isSent = message.senderId === 1;
                const messageClass = isSent ? 'sent' : 'received';
                const senderName = isSent ? 'æˆ‘' : message.senderName;
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${messageClass}`;
                messageElement.innerHTML = `
                    <div class="message-avatar">
                        ${senderName.substring(0, 1).toUpperCase()}
                    </div>
                    <div class="message-content">
                        <p class="message-text">${message.messageContent}</p>
                        <div class="message-meta">
                            <span class="message-time">${new Date(message.sentAt).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</span>
                            ${isSent ? `<span class="message-status">${message.readAt ? 'å·²è®€' : 'å·²ç™¼é€'}</span>` : ''}
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageElement);
            });
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function goBack() {
            window.location.href = '/Chat';
        }
        
        function clearChat() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºèŠå¤©è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) {
                alert('æ¸…ç©ºèŠå¤©åŠŸèƒ½é–‹ç™¼ä¸­...');
            }
        }
        
        // è‡ªå‹•èª¿æ•´è¼¸å…¥æ¡†é«˜åº¦
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // æŒ‰Enterç™¼é€æ¶ˆæ¯
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // å®šæœŸè¼‰å…¥æ–°æ¶ˆæ¯
        setInterval(loadMessages, 3000);
        
        // æ·»åŠ è«‹æ±‚é©—è­‰ä»¤ç‰Œ
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.createElement('form');
            form.style.display = 'none';
            form.innerHTML = '@Html.AntiForgeryToken()';
            document.body.appendChild(form);
        });
    </script>
</body>
</html>