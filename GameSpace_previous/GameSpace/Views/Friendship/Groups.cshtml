@model IEnumerable<GameSpace.Models.GroupMember>
@{
    ViewData["Title"] = "我的群組 - GameSpace";
    Layout = "_Layout";
}

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>我的群組 - GameSpace</title>
    <style>
        :root{
            --bg:#eef3f8; --bg2:#ffffff; --ink:#1f2937; --muted:#64748b; --line:#e5e7eb;
            --surface:rgba(255,255,255,.75); --glass:rgba(255,255,255,.45);
            --accent:#7557ff; --accent-2:#34d2ff; --accent-3:#22c55e; --accent-4:#ef4444;
            --radius:18px; --radius-sm:12px; --shadow:0 18px 40px rgba(17,24,39,.12);
            --blur:14px;
        }
        body.dark{
            --bg:#0c111b; --bg2:#0a0f18; --ink:#e5edff; --muted:#9fb1c9; --line:#1e2b43;
            --surface:rgba(22,30,48,.65); --glass:rgba(18,24,39,.50);
            --shadow:0 18px 42px rgba(0,0,0,.35);
        }
        *{box-sizing:border-box} html,body{height:100%}
        body{
            margin:0; color:var(--ink); font:16px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
            background:
                radial-gradient(900px 500px at -10% -10%, rgba(117,87,255,.10), transparent 60%),
                radial-gradient(800px 460px at 110% 10%, rgba(52,210,255,.10), transparent 50%),
                linear-gradient(180deg, var(--bg), var(--bg2));
        }
        .wrap{max-width:1200px; margin:0 auto; padding:0 16px}
        
        /* 標題 */
        .page-title{
            font-size:32px; font-weight:900; color:var(--ink); margin:40px 0 30px; text-align:center;
            display:flex; align-items:center; justify-content:center; gap:15px;
        }
        
        /* 統計卡片 */
        .stats-row{
            display:flex; gap:20px; margin-bottom:30px; justify-content:center;
        }
        .stat-card{
            background:var(--glass); border:1px solid var(--line); border-radius:20px; 
            padding:20px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
            text-align:center; min-width:150px;
        }
        .stat-value{
            font-size:24px; font-weight:900; color:var(--accent); margin-bottom:5px;
        }
        .stat-label{
            font-size:14px; color:var(--muted); text-transform:uppercase; font-weight:600;
        }
        
        /* 操作按鈕 */
        .actions{
            display:flex; gap:15px; margin-bottom:30px; justify-content:center; flex-wrap:wrap;
        }
        .btn{
            padding:12px 24px; border:none; border-radius:12px; font-weight:700;
            cursor:pointer; transition:all 0.3s ease; text-decoration:none; display:inline-block;
        }
        .btn-primary{
            background:var(--accent); color:#fff;
        }
        .btn-primary:hover{background:#6d28d9; transform:translateY(-2px)}
        .btn-secondary{
            background:var(--surface); color:var(--ink); border:1px solid var(--line);
        }
        .btn-secondary:hover{background:var(--line)}
        .btn-success{
            background:var(--accent-3); color:#fff;
        }
        .btn-success:hover{background:#16a34a; transform:translateY(-2px)}
        .btn-danger{
            background:var(--accent-4); color:#fff;
        }
        .btn-danger:hover{background:#dc2626; transform:translateY(-2px)}
        
        /* 群組列表 */
        .groups-container{
            background:var(--glass); border:1px solid var(--line); border-radius:20px; 
            backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow); overflow:hidden;
        }
        .group-item{
            padding:20px; border-bottom:1px solid var(--line); transition:all 0.3s ease;
            display:flex; align-items:center; gap:15px;
        }
        .group-item:hover{
            background:var(--surface);
        }
        .group-item:last-child{
            border-bottom:none;
        }
        
        .group-avatar{
            width:50px; height:50px; border-radius:50%; background:var(--accent);
            display:flex; align-items:center; justify-content:center; color:#fff;
            font-size:20px; font-weight:700;
        }
        
        .group-info{
            flex:1;
        }
        .group-name{
            font-size:18px; font-weight:700; color:var(--ink); margin-bottom:5px;
        }
        .group-desc{
            font-size:14px; color:var(--muted); margin-bottom:5px;
        }
        .group-meta{
            font-size:12px; color:var(--muted);
        }
        
        .group-actions{
            display:flex; gap:10px;
        }
        .btn-sm{
            padding:8px 16px; font-size:12px; border-radius:8px;
        }
        
        .role-badge{
            padding:2px 8px; border-radius:12px; font-size:10px; font-weight:700; text-transform:uppercase;
        }
        .role-owner{
            background:var(--accent); color:#fff;
        }
        .role-admin{
            background:var(--accent-2); color:#fff;
        }
        .role-moderator{
            background:var(--accent-3); color:#fff;
        }
        .role-member{
            background:var(--muted); color:#fff;
        }
        
        /* 空狀態 */
        .empty-state{
            text-align:center; padding:80px 20px; color:var(--muted);
        }
        .empty-icon{font-size:64px; margin-bottom:20px}
        .empty-title{font-size:24px; font-weight:700; margin-bottom:10px; color:var(--ink)}
        .empty-desc{font-size:16px}
        
        /* 創建群組模態框 */
        .modal{
            display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.5); z-index:1000;
            align-items:center; justify-content:center;
        }
        .modal-content{
            background:var(--bg2); border-radius:20px; padding:30px; max-width:500px; width:90%; box-shadow:var(--shadow);
        }
        .form-group{
            margin-bottom:20px;
        }
        .form-label{
            display:block; font-weight:700; color:var(--ink); margin-bottom:8px;
        }
        .form-control{
            width:100%; padding:12px 16px; border:1px solid var(--line); border-radius:12px;
            background:var(--bg2); color:var(--ink); font-size:16px;
        }
        .form-control:focus{
            outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(117,87,255,.1);
        }
        .checkbox-group{
            display:flex; align-items:center; gap:10px;
        }
        .checkbox{
            width:18px; height:18px;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <h1 class="page-title">
            <span>👥</span>
            我的群組
        </h1>
        
        <!-- 統計數據 -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value">@Model.Count()</div>
                <div class="stat-label">我的群組</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@Model.Count(g => g.Role == "Owner")</div>
                <div class="stat-label">我創建的</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@Model.Count(g => g.Role == "Member")</div>
                <div class="stat-label">我加入的</div>
            </div>
        </div>
        
        <!-- 操作按鈕 -->
        <div class="actions">
            <button class="btn btn-primary" onclick="showCreateGroupModal()">創建群組</button>
            <a href="/Friendship" class="btn btn-secondary">返回好友列表</a>
            <a href="/Friendship/Requests" class="btn btn-secondary">好友請求</a>
            <button class="btn btn-secondary" onclick="refreshGroups()">刷新列表</button>
        </div>
        
        <!-- 群組列表 -->
        <div class="groups-container">
            @if (Model.Any())
            {
                @foreach (var groupMember in Model)
                {
                    <div class="group-item" data-group-id="@groupMember.GroupId">
                        <div class="group-avatar">
                            @groupMember.Group.GroupName.Substring(0, 1).ToUpper()
                        </div>
                        <div class="group-info">
                            <div class="group-name">
                                @groupMember.Group.GroupName
                                <span class="role-badge role-@groupMember.Role.ToLower()">@groupMember.Role</span>
                            </div>
                            <div class="group-desc">@groupMember.Group.Description</div>
                            <div class="group-meta">
                                創建者: @groupMember.Group.OwnerUser.UserName | 
                                創建時間: @groupMember.Group.CreatedAt.ToString("yyyy/MM/dd") |
                                成員數: @groupMember.Group.GroupMembers.Count
                            </div>
                        </div>
                        <div class="group-actions">
                            <button class="btn btn-primary btn-sm" onclick="openGroupChat(@groupMember.GroupId)">
                                群組聊天
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="viewGroupInfo(@groupMember.GroupId)">
                                群組資料
                            </button>
                            @if (groupMember.Role != "Owner")
                            {
                                <button class="btn btn-danger btn-sm" onclick="leaveGroup(@groupMember.GroupId)">
                                    離開群組
                                </button>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-icon">👥</div>
                    <div class="empty-title">暫無群組</div>
                    <div class="empty-desc">開始創建或加入群組，與朋友們一起交流吧！</div>
                </div>
            }
        </div>
    </div>

    <!-- 創建群組模態框 -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0 0 20px; color:var(--ink);">創建群組</h3>
            <form id="createGroupForm">
                <div class="form-group">
                    <label class="form-label" for="groupName">群組名稱</label>
                    <input type="text" id="groupName" class="form-control" placeholder="輸入群組名稱..." required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="groupDesc">群組描述</label>
                    <textarea id="groupDesc" class="form-control" rows="3" placeholder="輸入群組描述..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="maxMembers">最大成員數</label>
                    <input type="number" id="maxMembers" class="form-control" placeholder="輸入最大成員數..." min="2" max="1000">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isPrivate" class="checkbox">
                        <label for="isPrivate">私人群組</label>
                    </div>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateGroupModal()">取消</button>
                    <button type="submit" class="btn btn-primary">創建群組</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'flex';
        }
        
        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
        }
        
        document.getElementById('createGroupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const groupName = document.getElementById('groupName').value;
            const groupDesc = document.getElementById('groupDesc').value;
            const maxMembers = document.getElementById('maxMembers').value;
            const isPrivate = document.getElementById('isPrivate').checked;
            
            if (!groupName.trim()) {
                alert('請輸入群組名稱');
                return;
            }
            
            fetch('/Friendship/CreateGroup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    groupName: groupName,
                    description: groupDesc,
                    maxMembers: maxMembers ? parseInt(maxMembers) : null,
                    isPrivate: isPrivate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeCreateGroupModal();
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('創建失敗，請稍後再試');
            });
        });
        
        function openGroupChat(groupId) {
            alert('打開群組 ' + groupId + ' 的聊天');
        }
        
        function viewGroupInfo(groupId) {
            alert('查看群組 ' + groupId + ' 的資料');
        }
        
        function leaveGroup(groupId) {
            if (confirm('確定要離開這個群組嗎？')) {
                fetch('/Friendship/LeaveGroup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ groupId: groupId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    alert('操作失敗，請稍後再試');
                });
            }
        }
        
        function refreshGroups() {
            location.reload();
        }
        
        // 添加請求驗證令牌
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.createElement('form');
            form.style.display = 'none';
            form.innerHTML = '@Html.AntiForgeryToken()';
            document.body.appendChild(form);
        });
    </script>
</body>
</html>