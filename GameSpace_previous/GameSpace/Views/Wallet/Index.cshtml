@{
    ViewData["Title"] = "æˆ‘çš„éŒ¢åŒ… - GameSpace";
    Layout = "_Layout";
    var wallet = ViewBag.Wallet as UserWallet;
    var history = ViewBag.History as List<WalletHistory>;
}

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æˆ‘çš„éŒ¢åŒ… - GameSpace</title>
    <style>
        :root{
            --bg:#eef3f8; --bg2:#ffffff; --ink:#1f2937; --muted:#64748b; --line:#e5e7eb;
            --surface:rgba(255,255,255,.75); --glass:rgba(255,255,255,.45);
            --accent:#7557ff; --accent-2:#34d2ff; --accent-3:#22c55e;
            --radius:18px; --radius-sm:12px; --shadow:0 18px 40px rgba(17,24,39,.12);
            --blur:14px;
        }
        body.dark{
            --bg:#0c111b; --bg2:#0a0f18; --ink:#e5edff; --muted:#9fb1c9; --line:#1e2b43;
            --surface:rgba(22,30,48,.65); --glass:rgba(18,24,39,.50);
            --shadow:0 18px 42px rgba(0,0,0,.35);
        }
        *{box-sizing:border-box} html,body{height:100%}
        body{
            margin:0; color:var(--ink); font:16px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
            background:
                radial-gradient(900px 500px at -10% -10%, rgba(117,87,255,.10), transparent 60%),
                radial-gradient(800px 460px at 110% 10%, rgba(52,210,255,.10), transparent 50%),
                linear-gradient(180deg, var(--bg), var(--bg2));
        }
        .wrap{max-width:1200px; margin:0 auto; padding:0 16px}
        
        /* éŒ¢åŒ…å¡ç‰‡ */
        .wallet-card{
            background:var(--glass); border:1px solid var(--line); border-radius:20px; 
            padding:30px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
            text-align:center; margin:20px 0;
        }
        .wallet-balance{font-size:48px; font-weight:900; color:var(--accent); margin-bottom:10px}
        .wallet-label{font-size:18px; color:var(--muted); margin-bottom:30px}
        
        /* æ“ä½œæŒ‰éˆ• */
        .wallet-actions{display:flex; gap:15px; justify-content:center; margin:30px 0}
        .btn-wallet{
            padding:15px 30px; border:none; border-radius:12px; font-weight:700; cursor:pointer;
            transition:all 0.3s ease; box-shadow:var(--shadow); font-size:16px;
        }
        .btn-add{background:linear-gradient(135deg,var(--accent-3),#16a34a); color:#fff}
        .btn-spend{background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff}
        .btn-wallet:hover{transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,0.15)}
        
        /* äº¤æ˜“æ­·å² */
        .history-section{margin:30px 0}
        .history-title{font-size:24px; font-weight:900; color:var(--ink); margin-bottom:20px}
        .history-item{
            background:var(--glass); border:1px solid var(--line); border-radius:15px; 
            padding:20px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
            margin:10px 0; display:flex; justify-content:space-between; align-items:center;
        }
        .history-info{flex:1}
        .history-type{font-weight:700; color:var(--ink); margin-bottom:5px}
        .history-desc{color:var(--muted); font-size:14px}
        .history-amount{font-size:18px; font-weight:900}
        .history-amount.positive{color:var(--accent-3)}
        .history-amount.negative{color:#ef4444}
        .history-time{color:var(--muted); font-size:12px}
        
        /* è¡¨å–® */
        .form-modal{
            position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5);
            display:none; align-items:center; justify-content:center; z-index:1000;
        }
        .form-content{
            background:var(--glass); border:1px solid var(--line); border-radius:20px;
            padding:30px; backdrop-filter:blur(var(--blur)); box-shadow:var(--shadow);
            min-width:400px; max-width:500px;
        }
        .form-title{font-size:24px; font-weight:900; color:var(--ink); margin-bottom:20px; text-align:center}
        .form-group{margin-bottom:20px}
        .form-label{display:block; font-weight:700; color:var(--ink); margin-bottom:8px}
        .form-control{
            width:100%; padding:12px 16px; border:2px solid var(--line); border-radius:12px;
            background:var(--surface); color:var(--ink); font-size:16px;
            transition:border-color 0.3s ease;
        }
        .form-control:focus{outline:none; border-color:var(--accent)}
        .form-actions{display:flex; gap:15px; justify-content:flex-end; margin-top:30px}
        .btn-cancel{background:var(--surface); color:var(--ink); border:2px solid var(--line); padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer}
        .btn-submit{background:linear-gradient(135deg,var(--accent),#3b82f6); color:#fff; border:none; padding:12px 24px; border-radius:12px; font-weight:700; cursor:pointer}
    </style>
</head>
<body>
    <div class="wrap">
        <div class="wallet-card">
            <div class="wallet-balance">@wallet.UserPoint.ToString("N0")</div>
            <div class="wallet-label">ğŸ’° æˆ‘çš„é»æ•¸é¤˜é¡</div>
            
            <div class="wallet-actions">
                <button class="btn-wallet btn-add" onclick="showAddForm()">+ å……å€¼é»æ•¸</button>
                <button class="btn-wallet btn-spend" onclick="showSpendForm()">- æ¶ˆè²»é»æ•¸</button>
            </div>
        </div>
        
        <div class="history-section">
            <h2 class="history-title">ğŸ“Š äº¤æ˜“è¨˜éŒ„</h2>
            @if (history.Any())
            {
                @foreach (var item in history)
                {
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-type">@item.TransactionType</div>
                            <div class="history-desc">@item.Description</div>
                            <div class="history-time">@item.CreatedAt.ToString("yyyy/MM/dd HH:mm")</div>
                        </div>
                        <div class="history-amount @(item.Amount > 0 ? "positive" : "negative")">
                            @(item.Amount > 0 ? "+" : "")@item.Amount.ToString("N0")
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="text-align:center; padding:40px; color:var(--muted)">
                    <div style="font-size:48px; margin-bottom:20px">ğŸ“­</div>
                    <div style="font-size:18px; font-weight:700; margin-bottom:10px; color:var(--ink)">æš«ç„¡äº¤æ˜“è¨˜éŒ„</div>
                    <div>é–‹å§‹ä½¿ç”¨éŒ¢åŒ…åŠŸèƒ½å§ï¼</div>
                </div>
            }
        </div>
    </div>

    <!-- å……å€¼è¡¨å–® -->
    <div class="form-modal" id="addForm">
        <div class="form-content">
            <h3 class="form-title">ğŸ’° å……å€¼é»æ•¸</h3>
            <form id="addPointsForm">
                <div class="form-group">
                    <label class="form-label" for="addAmount">å……å€¼é‡‘é¡</label>
                    <input type="number" id="addAmount" name="amount" class="form-control" min="1" max="10000" step="1" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="hideAddForm()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit">ç¢ºèªå……å€¼</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ¶ˆè²»è¡¨å–® -->
    <div class="form-modal" id="spendForm">
        <div class="form-content">
            <h3 class="form-title">ğŸ’¸ æ¶ˆè²»é»æ•¸</h3>
            <form id="spendPointsForm">
                <div class="form-group">
                    <label class="form-label" for="spendAmount">æ¶ˆè²»é‡‘é¡</label>
                    <input type="number" id="spendAmount" name="amount" class="form-control" min="1" max="@wallet.UserPoint" step="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="spendDesc">æ¶ˆè²»èªªæ˜</label>
                    <input type="text" id="spendDesc" name="description" class="form-control" placeholder="è«‹è¼¸å…¥æ¶ˆè²»èªªæ˜">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="hideSpendForm()">å–æ¶ˆ</button>
                    <button type="submit" class="btn-submit">ç¢ºèªæ¶ˆè²»</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showAddForm() {
            document.getElementById('addForm').style.display = 'flex';
        }
        
        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
        }
        
        function showSpendForm() {
            document.getElementById('spendForm').style.display = 'flex';
        }
        
        function hideSpendForm() {
            document.getElementById('spendForm').style.display = 'none';
        }
        
        // å……å€¼è¡¨å–®æäº¤
        document.getElementById('addPointsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('addAmount').value);
            
            fetch('/Wallet/AddPoints', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ amount: amount })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
        });
        
        // æ¶ˆè²»è¡¨å–®æäº¤
        document.getElementById('spendPointsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('spendAmount').value);
            const description = document.getElementById('spendDesc').value;
            
            fetch('/Wallet/SpendPoints', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ 
                    amount: amount,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
        });
        
        // æ·»åŠ è«‹æ±‚é©—è­‰ä»¤ç‰Œ
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.createElement('form');
            form.style.display = 'none';
            form.innerHTML = '@Html.AntiForgeryToken()';
            document.body.appendChild(form);
        });
    </script>
</body>
</html>